# .github/workflows/desktop-release.yml
#
# note: we build on ubuntu 22.04 instead of ubuntu-latest so that our binary
# is compatible with older GLIBC.

name: Publish Desktop Release

# 1. Trigger on tags OR pushes to main/master branches
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

# so the upload step can work
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build on ${{ matrix.os }}

    # Run this job on all three platforms
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Changed 'ubuntu-latest' to 'ubuntu-22.04'
        os: [ubuntu-22.04, windows-latest, macos-latest]

    env:
      # disable incremental builds
      CARGO_INCREMENTAL: '0'

      # Fix 1 (tokio) & 2 (Stack Overflow) for Windows
      RUSTFLAGS: >
        ${{
          matrix.os == 'windows-latest' &&
          '--cfg tokio_unstable -C link-arg=/STACK:8388608' ||
          '--cfg tokio_unstable'
        }}

      # Fix 2 (macOS): Force-fix the ancient leveldb-sys cmake script
      CMAKE_FLAGS: >
        ${{
          matrix.os == 'macos-latest' &&
          '-DCMAKE_POLICY_VERSION_MINIMUM=3.5' ||
          ''
        }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # install dioxus-cli from source.
      # Includes fix for windows link error:
      # https://github.com/DioxusLabs/dioxus/issues/4998
      - name: Install dioxus-cli (v0.7.1, patched) from Source
        # Use a shell that recognizes '\' continuation char
        shell: bash
        run: |
          cargo install dioxus-cli \
            --git https://github.com/DioxusLabs/dioxus \
            --rev 84efc00757c5aac67177821d05769a653a809f66 \
            --force

      # Install Dioxus desktop dependencies (Linux only)
      # This is critical for the AppImage build
      - name: Install Linux Dependencies
        # Updated this condition to match the matrix
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config \
            librsvg2-dev \
            libv4l-dev \
            libxdo-dev

      - name: Install macOS Dependencies
        if: matrix.os == 'macos-latest'
        run: |
          brew install leveldb snappy

          # --- Fix for OpenSSL (reqwest) ---
          OPENSSL_DIR=$(brew --prefix openssl@3)
          echo "OPENSSL_ROOT_DIR=$OPENSSL_DIR" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$OPENSSL_DIR/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include" >> $GITHUB_ENV

          # --- Fix for CMake (leveldb-sys) ---
          echo "CMAKE_POLICY_VERSION_MINIMUM=3.5" >> $GITHUB_ENV

          # --- Fix for LevelDB/Snappy (just in case) ---
          # Build the PKG_CONFIG_PATH safely
          PKG_PATH="$(brew --prefix openssl@3)/lib/pkgconfig"
          PKG_PATH="$PKG_PATH:$(brew --prefix leveldb)/lib/pkgconfig"
          PKG_PATH="$PKG_PATH:$(brew --prefix snappy)/lib/pkgconfig"
          echo "PKG_CONFIG_PATH=$PKG_PATH" >> $GITHUB_ENV


      # Install cargo-tree (for debugging)
      - name: Install cargo-tree
        run: cargo install cargo-tree

      # Show Build Dependency Tree (for debugging)
      - name: Show Build Dependency Tree
        # Only run on the failing OS
        if: matrix.os == 'windows-latest'
        run: |
          cd desktop
          cargo tree --features desktop --target x86_64-pc-windows-msvc -e build
        # Don't stop the build if this fails
        continue-on-error: true

      # Windows: Run the custom wrapper script from the repo root
      # We use 'shell: bash' to ensure the .sh script runs correctly on Windows
      - name: Bundle Dioxus App (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: ./tools/windows/bundle-release.sh

      # Non-Windows: Run the standard command
      - name: Bundle Dioxus App (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd desktop
          dx bundle --release --trace

      # Upload the final installer to the GitHub Release
      # We only run this step if the reference is a tag
      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            target/dx/neptune-proton/bundle/*/*/*/*.AppImage
            target/dx/neptune-proton/bundle/*/*/*/*.deb
            target/dx/neptune-proton/bundle/*/*/*/*.rpm
            target/dx/neptune-proton/bundle/*/*/*/*.msi
            target/dx/neptune-proton/bundle/*/*/*/*.exe
            target/dx/neptune-proton/bundle/*/*/*/*.dmg

      - name: ⬆️ Upload macOS DMG Installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-dmg-installer
          # Your specified path for DMG files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.dmg
          if-no-files-found: ignore
          retention-days: 1

      - name: ⬆️ Upload Windows MSI Installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-msi-installer
          # Your specified path for MSI files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.msi
          if-no-files-found: ignore
          retention-days: 1

      - name: ⬆️ Upload Windows EXE Installer
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-exe-installer
          # Your specified path for EXE files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.exe
          if-no-files-found: ignore
          retention-days: 1

      - name: ⬆️ Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-appimage
          # Your specified path for AppImage files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.AppImage
          if-no-files-found: ignore
          retention-days: 1

      - name: ⬆️ Upload Linux DEB Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-deb-package
          # Your specified path for DEB files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.deb
          if-no-files-found: ignore
          retention-days: 1

      - name: ⬆️ Upload Linux RPM Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-rpm-package
          # Your specified path for RPM files:
          path: target/dx/neptune-proton/bundle/*/*/*/*.rpm
          if-no-files-found: ignore
          retention-days: 1

      - name: Start tmate debug session
        uses: mxschmitt/action-tmate@v3
        # This step will run on all OSes.
        # It will only run if the workflow is manually triggered
        # or if a previous step has failed.
        if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
        with:
          # This makes the job wait for 30 minutes for you to connect
          limit-access-to-actor: true
          # 30 minutes
          timeout: 1800
