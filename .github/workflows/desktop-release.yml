# .github/workflows/desktop-release.yml
#
# note: we build on ubuntu 22.04 instead of ubuntu-latest so that our binary
# is compatible with older GLIBC.

name: Publish Desktop Release

# 1. Trigger on tags OR pushes to main/master branches
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

# so the upload step can work
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build on ${{ matrix.os }}

    # Run this job on all three platforms
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # specify older linux (22.04) for widest glibc compatibility.
        os: [ubuntu-22.04, windows-latest, macos-latest]

    env:
      # disable incremental builds
      CARGO_INCREMENTAL: '0'

      # Fix 1 (tokio) & 2 (Stack Overflow) for Windows
      RUSTFLAGS: >
        ${{
          matrix.os == 'windows-latest' &&
          '--cfg tokio_unstable -C link-arg=/STACK:8388608' ||
          '--cfg tokio_unstable'
        }}

      # Fix 2 (macOS): Force-fix the ancient leveldb-sys cmake script
      CMAKE_FLAGS: >
        ${{
          matrix.os == 'macos-latest' &&
          '-DCMAKE_POLICY_VERSION_MINIMUM=3.5' ||
          ''
        }}

    steps:

      - name: Checkout code (fetch full history & tags)
        uses: actions/checkout@v4
        with:
          # This fetches all history (depth 0) and all tags.
          # required to get the correct version of CHANGELOG.md from the tagged commit.
          fetch-depth: 0       

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # install dioxus-cli from source.
      # Includes fix for windows link error:
      # https://github.com/DioxusLabs/dioxus/issues/4998
      - name: Install dioxus-cli (v0.7.1, patched) from Source
        # Use a shell that recognizes '\' continuation char
        shell: bash
        run: |
          cargo install dioxus-cli \
            --git https://github.com/DioxusLabs/dioxus \
            --rev 84efc00757c5aac67177821d05769a653a809f66 \
            --force

      # Install Dioxus desktop dependencies (Linux only)
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config \
            librsvg2-dev \
            libv4l-dev \
            libxdo-dev

      - name: Install macOS Dependencies
        if: matrix.os == 'macos-latest'
        run: |
          brew install leveldb snappy

          # --- Fix for OpenSSL (reqwest) ---
          OPENSSL_DIR=$(brew --prefix openssl@3)
          echo "OPENSSL_ROOT_DIR=$OPENSSL_DIR" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$OPENSSL_DIR/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include" >> $GITHUB_ENV

          # --- Fix for CMake (leveldb-sys) ---
          echo "CMAKE_POLICY_VERSION_MINIMUM=3.5" >> $GITHUB_ENV

          # --- Fix for LevelDB/Snappy (just in case) ---
          # Build the PKG_CONFIG_PATH safely
          PKG_PATH="$(brew --prefix openssl@3)/lib/pkgconfig"
          PKG_PATH="$PKG_PATH:$(brew --prefix leveldb)/lib/pkgconfig"
          PKG_PATH="$PKG_PATH:$(brew --prefix snappy)/lib/pkgconfig"
          echo "PKG_CONFIG_PATH=$PKG_PATH" >> $GITHUB_ENV


      # Install cargo-tree (for debugging)
      - name: Install cargo-tree
        run: cargo install cargo-tree

      # Show Build Dependency Tree (for debugging)
      - name: Show Build Dependency Tree
        # Only run on the failing OS
        if: matrix.os == 'windows-latest'
        run: |
          cd desktop
          cargo tree --features desktop --target x86_64-pc-windows-msvc -e build
        # Don't stop the build if this fails
        continue-on-error: true

      # Windows: Run the custom wrapper script from the repo root
      # We use 'shell: bash' to ensure the .sh script runs correctly on Windows
      - name: Bundle Dioxus App (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: ./tools/windows/bundle-release.sh

      # Non-Windows: Run the standard command
      - name: Bundle Dioxus App (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd desktop
          dx bundle --release --trace

      # ---------------------------------------------------------
      # NEW STEP: Extract Release Notes from CHANGELOG.md
      # ---------------------------------------------------------
      - name: Extract Release Notes
        id: extract_notes
        # Only run on macos-latest and on a tag push, as only one runner needs to extract the text.
        if: matrix.os == 'macos-latest' && startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          # Get the current tag name (e.g., v1.2.3)
          TAG_NAME="${{ github.ref_name }}"
          
          # Use awk to extract the section between '## $TAG_NAME' and the next '## ' or EOF
          # This assumes the CHANGELOG.md file was committed with the tag.
          awk "/^## $TAG_NAME/{p=1; next}/^## /{p=0}p" CHANGELOG.md > release_body.md
          
          # Check if extraction failed (e.g., the file wasn't found or formatted incorrectly)
          if [ ! -s release_body.md ]; then
            echo "Error: Could not extract release notes for $TAG_NAME from CHANGELOG.md. Creating fallback." >&2
            echo "## Release $TAG_NAME" > release_body.md
          fi
          
          # Set the path to the file for the next step to use
          echo "release_body_path=release_body.md" >> $GITHUB_OUTPUT
          
      # ------------------------------------------------------------------
      # Collect Assets (Staging Step)
      # ------------------------------------------------------------------
      - name: Collect Release Assets
        shell: bash
        run: |
          mkdir -p release-assets

          # Find only the final binary artifacts.
          find target/dx/neptune-proton/bundle -type f \( \
            -name "*.AppImage" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.msi" -o \
            -name "*.exe" -o \
            -name "*.dmg" \
          \) -exec cp {} release-assets/ \;

          echo "Final set of artifacts for release:"
          ls -lh release-assets/

      # ------------------------------------------------------------------
      # Generate Checksums (Generic)
      # ------------------------------------------------------------------
      - name: Generate Checksums
        shell: bash
        run: |
          cd release-assets
          
          # Choose the correct hashing tool
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            CMD="shasum -a 256"
          else
            CMD="sha256sum"
          fi
          
          $CMD * > "../checksums-${{ matrix.os }}.txt"
          mv "../checksums-${{ matrix.os }}.txt" .
          
          echo "Checksums content:"
          cat "checksums-${{ matrix.os }}.txt"

      # ------------------------------------------------------------------
      # Upload Release to GitHub (when 'v...' tag is pushed)
      # ------------------------------------------------------------------
      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          # Use the extracted file content (body_path is preferred over body)
          body_path: ${{ steps.extract_notes.outputs.release_body_path }}
          # Only macOS needs to update the release text, but using body_path 
          # on a single runner (macos-latest) handles this naturally.
          append_body: ${{ matrix.os == 'macos-latest' }} 
          # Upload everything in the staging folder
          files: release-assets/*

      # ------------------------------------------------------------------
      # 5. Upload Artifacts to Action Summary (when commit(s) pushed)
      # ------------------------------------------------------------------
      - name: ⬆️ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: release-assets/
          if-no-files-found: ignore
          retention-days: 1

      - name: Start tmate debug session
        uses: mxschmitt/action-tmate@v3
        if: ${{ failure() || github.event_name == 'workflow_dispatch' }}
        with:
          limit-access-to-actor: true
          timeout: 1800
